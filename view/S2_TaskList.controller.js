/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/core/mvc/ViewType","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/MessageToast","sap/m/TablePersoController","sap/m/GroupHeaderListItem","cross/fnd/fiori/inbox/util/TableOperations","cross/fnd/fiori/inbox/util/TaskListGroupingHelper","cross/fnd/fiori/inbox/util/TaskListSortingHelper","cross/fnd/fiori/inbox/util/TaskListCustomAttributeHelper","cross/fnd/fiori/inbox/util/DataManager","sap/ca/scfld/md/controller/BaseFullscreenController","sap/m/semantic/PositiveAction","sap/m/semantic/NegativeAction","sap/m/Button","cross/fnd/fiori/inbox/util/ConfirmationDialogManager","cross/fnd/fiori/inbox/util/Forward","cross/fnd/fiori/inbox/util/Resubmit","cross/fnd/fiori/inbox/util/MultiSelect","cross/fnd/fiori/inbox/util/ActionHelper"],function(U,V,S,F,a,J,C,M,T,G,b,c,d,e,D,B,P,N,f,g,h,R,l,A){"use strict";B.extend("cross.fnd.fiori.inbox.view.S2_TaskList",{ClaimFunctionImport:"Claim",ReleaseFunctionImport:"Release",DecisionFunctionImport:"Decision",ConfirmFunctionImport:"Confirm",GUILinkProperty:"GUI_Link",extHookChangeFooterButtonsForExpertMode:null,onInit:function(){this.mainViewModel=new sap.ui.model.json.JSONModel({busy:true,delay:0});this.getView().setModel(this.mainViewModel,"mainView");var o=sap.ca.scfld.md.app.Application.getImpl().getComponent();this.oDataManager=o.getDataManager();o.getEventBus().subscribe("cross.fnd.fiori.inbox","refreshTask",jQuery.proxy(this._refreshTask,this));this._oResourceBundle=this.getView().getModel("i18n").getResourceBundle();var v=new sap.ui.model.json.JSONModel({personalizationActive:false,taskListTitle:this._oResourceBundle.getText("ITEMS_SCENARIO_DISPLAY_NAME"),noDataText:this._oResourceBundle.getText("XMSG_LOADING")});this.getView().setModel(v,"taskListView");this._oTable=this.byId("taskListTable");this._oTable.setBusyIndicatorDelay(0);this._oFullScreenPage=this.getView().byId("taskListPage");this._oDataModel=this.getView().getModel();this._initPersonalization();this._aTaskPropertiesForSelect=["SAP__Origin","InstanceID","TaskDefinitionID","TaskDefinitionName","TaskTitle","Priority","PriorityNumber","Status","StatusText","CreatedBy","CreatedByName","CreatedOn","CompletionDeadLine","HasAttachments","TaskSupports","SupportsComments","SupportsAttachments","CustomAttributeData"];this._oTableOperations=new b(this._oTable,this.getView(),["TaskTitle","Priority","Status","CreatedByName","CompletionDeadLine","CreatedOn"]);this._oGrouping=new c(this._oTableOperations,this.getView());this._oSorting=new d(this._oTableOperations,this.getView());this._tableHelper=new e(this,this.getView(),this._oTable,this._oGrouping,this._oSorting,this._oTableOperations);this._actionHelper=new A(this,this.getView());this._oConfirmationDialogManager=g;this.sResubmitUniqueId=this.createId()+"DLG_RESUBMIT";this._oDataModel.attachRequestSent($.proxy(function(){this._oTable.setShowNoData(false);this._oTable.setBusy(true);},this));this._oDataModel.attachRequestCompleted($.proxy(function(){this._oTable.setBusy(false);this._oTable.setShowNoData(true);},this));this._oDataModel.attachRequestFailed($.proxy(function(){this.mainViewModel.setProperty("/busy",false);this._oTable.setShowNoData(true);},this));if(!this.oDataManager.oModel.getServiceMetadata()){this.oDataManager.oModel.attachMetadataLoaded(jQuery.proxy(function(){this._loadInitialAppData();},this));}else{this._loadInitialAppData();}this._loadCustomAttributesDeferredForTasks=$.Deferred();this._loadCustomAttributesDeferredForTaskDefs=$.Deferred();this.byId("taskListPage").insertContent(this._initFBSubView(),0);},onExit:function(){this._tableHelper.destroy();},_loadInitialAppData:function(){this._loadScenrioDeferred=$.Deferred();if(this.oDataManager.sScenarioId||this.oDataManager.sClientScenario){this.oDataManager.loadInitialAppData($.proxy(function(s){if(!s){return;}this._oScenario=s;this._scenarioServiceInfos=s.ScenarioServiceInfos;var o=this.oDataManager.getScenarioConfig();if((s.ScenarioServiceInfos.length===1)||(o.AllItems===true)){this._displaySortOption=true;}this._displayMultiSelectButton=o.IsMassActionEnabled;this._defaultSortKey=o.SortBy;this._loadScenrioDeferred.resolve();},this));}else{var o=this.oDataManager.getScenarioConfig();if(o.AllItems===true){this._displayMultiSelectButton=o.IsMassActionEnabled?true:false;this._displaySortOption=true;this._defaultSortKey=o.SortBy;}this._loadScenrioDeferred.resolve();}$.when(this._loadScenrioDeferred).then($.proxy(function(){this._oTableOperations.addSorter(this._getDefaultSorter());this._initTaskDefintionModel();this.oDataManager.oModel.getMetaModel().loaded().then(jQuery.proxy(function(){this._storeMetaModel();this._initTaskModel();},this));},this));},_initTaskDefintionModel:function(){var _=function(o,r){if(r.statusCode==="200"){var i=this._identifyColumnsTobeAdded(o.results);var j=new J({TaskDefinitionCollection:o.results,Columns:i});this.getView().setModel(j,"taskDefinitions");this._loadCustomAttributesDeferredForTaskDefs.resolve();}else{jQuery.sap.require("sap.m.MessageToast");sap.m.MessageToast.show(r.statusText+":"+r.body);}};var t=this._getTaskDefinitionFilters();if(t){t=[t];}var p={filters:t,success:$.proxy(_,this),urlParameters:{$select:"SAP__Origin,TaskDefinitionID,TaskName,CustomAttributeDefinitionData",$expand:"CustomAttributeDefinitionData"}};this._oDataModel.read("/TaskDefinitionCollection",p);},_initTaskModel:function(){var _=function(o,r){if(r.statusCode==="200"){var j=this._dataMassage(o.results);var k=new J({TaskCollection:j});this.getView().setModel(k,"taskList");this._loadCustomAttributesDeferredForTasks.resolve();if(this._filterDeferred){this._filterDeferred.resolve();}}else{jQuery.sap.require("sap.m.MessageToast");sap.m.MessageToast.show(r.statusText+":"+r.body);}};var i=[this._getinitialStatusFilters()];var t=this._getTaskDefinitionFilters();if(t){i.push(t);}var p={filters:[new F({filters:i,and:true})],sorters:[this._getCurrentSorter()],success:$.proxy(_,this),urlParameters:{$top:this.oDataManager.getListSize(),$select:this._getTaskPropertiesToFetch().join(","),$expand:"CustomAttributeData"}};this._oDataModel.read("/TaskCollection",p);},_refreshTask:function(i,j,k){var _=function(o,r){if(r.statusCode==="200"){var t=this._dataMassage([o]);var m=this.getView().getModel("taskList");m.setProperty(this.selectedTaskPath,t[0]);this.selectedTaskPath=undefined;this.handleSelectionChange();}};var p={success:$.proxy(_,this),urlParameters:{$expand:"CustomAttributeData"}};this._oDataModel.read(k.contextPath,p);},_storeMetaModel:function(){if(!this.oDataManager.oServiceMetaModel){this.oDataManager.oServiceMetaModel=this.oDataManager.oModel.getMetaModel();}},_getTaskPropertiesToFetch:function(){var p=this._aTaskPropertiesForSelect.concat();if(this._actionHelper.fnCheckGUILinkPropertySupported.call(this)){p.push(this.GUILinkProperty);}return p;},_getinitialStatusFilters:function(){var i=[];i.push(new F({path:"Status",operator:sap.ui.model.FilterOperator.EQ,value1:"READY"}));i.push(new F({path:"Status",operator:sap.ui.model.FilterOperator.EQ,value1:"RESERVED"}));i.push(new F({path:"Status",operator:sap.ui.model.FilterOperator.EQ,value1:"IN_PROGRESS"}));i.push(new F({path:"Status",operator:sap.ui.model.FilterOperator.EQ,value1:"EXECUTED"}));return new F({filters:i,and:false});},_getTaskDefinitionFilters:function(){if(this._scenarioServiceInfos){var t=[];for(var j=0;j<this._scenarioServiceInfos.length;j++){for(var k=0;k<this._scenarioServiceInfos[j].TaskDefinitionIDs.length;k++){t.push(new F({path:"TaskDefinitionID",operator:sap.ui.model.FilterOperator.EQ,value1:this._scenarioServiceInfos[j].TaskDefinitionIDs[k]}));}}return new F({filters:t,and:false});}},_getDefaultSorter:function(){var i=false;var s=this._defaultSortKey;if(s==="CreatedOn"){i=true;}if(s==="Priority"){s="PriorityNumber";}if(s==="CreatedBy"){s="CreatedByName";}return new S(s,i);},_getCurrentSorter:function(){var i=this._oTableOperations.getSorter()[0];if(["TaskTitle","Status","PriorityNumber","CreatedOn","CompletionDeadLine","CreatedByName"].indexOf(i.sPath)!==-1){return i;}else{return this._getDefaultSorter();}},_getTaskDefinitions:function(){var m=[];if(this._scenarioServiceInfos){for(var j=0;j<this._scenarioServiceInfos.length;j++){for(var k=0;k<this._scenarioServiceInfos[j].TaskDefinitionIDs.length;k++){m=m.concat(this._scenarioServiceInfos[j].TaskDefinitionIDs[k]);}}}return m;},_getScenrio:function(){return this._oScenario?this._oScenario.DisplayName:this._oResourceBundle.getText("ALL_ITEMS_SCENARIO_DISPLAY_NAME");},_getScenrioId:function(){var i="";if(this.oDataManager.sScenarioId){i=this.oDataManager.sScenarioId;}else if(this.oDataManager.sClientScenario){i="clntScenario";}else{i="allItems";}return i;},_identifyColumnsTobeAdded:function(t){var j={};for(var i=0;i<t.length;i++){t[i].TaskDefinitionID=t[i].TaskDefinitionID.toUpperCase();j[t[i].TaskDefinitionID]=t[i].CustomAttributeDefinitionData.results;}return j;},_dataMassage:function(t){var o;for(var i=0;i<t.length;i++){o=t[i];for(var j=0;j<o.CustomAttributeData.results.length;j++){o[encodeURIComponent(o.CustomAttributeData.results[j].Name)]=o.CustomAttributeData.results[j].Value;}t[i]=o;}return t;},_initFBSubView:function(){var v={viewName:"cross.fnd.fiori.inbox.view.S2_FilterBar",type:V.XML,viewData:{oTable:this._oTable,oTableOperations:this._oTableOperations,oTableHelper:this._tableHelper,parentController:this}};return sap.ui.view(v);},_initPersonalization:function(){if(sap.ushell.Container){var p=sap.ushell.Container.getService("Personalization");var o=p.getPersonalizer({container:"cross.fnd.fiori.inbox.table."+this._getScenrioId(),item:"taskListTable"});this._oTablePersoController=new sap.m.TablePersoController({table:this._oTable,componentName:"table",showResetAll:false,persoService:o}).activate();}this.getView().getModel("taskListView").setProperty("/personalizationActive",!!sap.ushell.Container);},onTaskSelected:function(E){var p={SAP__Origin:E.getSource().getBindingContext("taskList").getProperty("SAP__Origin"),InstanceID:E.getSource().getBindingContext("taskList").getProperty("InstanceID"),contextPath:"TaskCollection(SAP__Origin='"+E.getSource().getBindingContext("taskList").getProperty("SAP__Origin")+"',InstanceID='"+E.getSource().getBindingContext("taskList").getProperty("InstanceID")+"')"};this.selectedTaskPath=E.getSource().getBindingContext("taskList").getPath();this.oRouter.navTo("detail_deep",p,false);return;},onTaskTitlePressed:function(E){var p=E.getSource().getBindingContext("taskList").getProperty();this.oDataManager.fetchUIExecutionLink(p,jQuery.proxy(this._actionHelper.openTaskInNewWindow,this._actionHelper),jQuery.proxy(this._actionHelper.showErrorOnOpenTask,this._actionHelper));},onUpdateFinished:function(E){this.mainViewModel.setProperty("/busy",false);if(sap.ui.Device.system.phone){return;}var i=E.getParameter("total");this.getView().getModel("taskListView").setProperty("/taskListTitle",i?this._oResourceBundle.getText("ITEMS_SCENARIO_DISPLAY_NAME_COUNT",[i]):this._oResourceBundle.getText("ITEMS_SCENARIO_DISPLAY_NAME"));this.getView().getModel("taskListView").setProperty("/noDataText",this._oResourceBundle.getText("view.Workflow.noDataTasks"));},onPersonalizationPressed:function(){this._oTablePersoController.openDialog();},createGroupHeader:function(o){return new G({title:o.text,upperCase:false});},onGroupPressed:function(){this._oGrouping.openGroupingDialog();},onSortPressed:function(){this._oSorting.openSortingDialog();},attachControl:function(o){var s=this.getOwnerComponent().getContentDensityClass();jQuery.sap.syncStyleClass(s,this.getView(),o);this.getView().addDependent(o);},onMessagesButtonPress:function(E){if(!this._oMessagePopover){this._oMessagePopover=new sap.m.MessagePopover({items:{path:"message>/",template:new sap.m.MessagePopoverItem({description:"{message>description}",type:"{message>type}",title:"{message>message}"})}});this._oMessagePopover.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this.attachControl(this._oMessagePopover);}this._oMessagePopover.openBy(E.getSource());},setFilterBar:function(i){this._oFilterBar=i;},onRefreshPressed:function(E){this._filterDeferred=$.Deferred();this._initTaskModel();$.when(this._filterDeferred).then($.proxy(function(){this._oFilterBar.fireSearch();},this));},onNavBack:function(E){window.history.go(-1);},handleSelectionChange:function(E){this.clearFooterButtons();var s=this._oTable.getSelectedContexts();this.findCommonButtonsForSelectedTasks(s);},clearFooterButtons:function(){this._oFullScreenPage.setPositiveAction(null);this._oFullScreenPage.setNegativeAction(null);this._oFullScreenPage.removeAllCustomFooterContent();this.oSelectedTasksDetails=null;this.oPositiveButton=null;this.oNegativeButton=null;},findCommonButtonsForSelectedTasks:function(s){if(s.length===0){return;}this.oSelectedTasksDetails=this._actionHelper.getSelectedTasksDetails(s);if(this.oSelectedTasksDetails.bContainsConfirmableItem||(this.oDataManager.getScenarioConfig().AllItems&&this.oSelectedTasksDetails.aSelectedTaskTypes.length>1)){this.createFooterButtonsForSelectedTasks([]);}else if(this.oDataManager.getScenarioConfig().AllItems){this.oDataManager.readDecisionOptions(this.oSelectedTasksDetails.aItems[0].SAP__Origin,this.oSelectedTasksDetails.aItems[0].InstanceID,this.oSelectedTasksDetails.aSelectedTaskTypes[0],jQuery.proxy(this.createFooterButtonsForSelectedTasks,this),null,false);}else{this.oDataManager.massReadDecisionOptions(this.oSelectedTasksDetails.oSelectedTaskTypes,jQuery.proxy(this.createFooterButtonsWithScenario,this));}},createFooterButtonsWithScenario:function(i){this.createFooterButtonsForSelectedTasks(this._actionHelper.getCommonDecisionsForMultipleTasks(i));},createFooterButtonsForSelectedTasks:function(k){if(this.oSelectedTasksDetails.bContainsConfirmableItem&&this.oSelectedTasksDetails.SupportsConfirm){this._oFullScreenPage.setPositiveAction(this.getPositiveButton(null));}else if(!this.oSelectedTasksDetails.bContainsConfirmableItem){for(var i in k){var o=k[i];var m=new f({text:o.DecisionText,press:jQuery.proxy(this.showDecisionDialog,this,o)});switch(o.Nature){case"POSITIVE":m.setType(sap.m.ButtonType.Accept);break;case"NEGATIVE":m.setType(sap.m.ButtonType.Reject);}this._oFullScreenPage.addCustomFooterContent(m);}}if(this.oSelectedTasksDetails.SupportsClaim){this._oFullScreenPage.addCustomFooterContent(this.getClaimButton());}if(this.oSelectedTasksDetails.SupportsRelease){this._oFullScreenPage.addCustomFooterContent(this.getReleaseButton());}if(this.oSelectedTasksDetails.SupportsResubmit){this._oFullScreenPage.addCustomFooterContent(this.getResubmitButton());}var n={};n.aFooterButtons=this._oFullScreenPage.getCustomFooterContent();n.oPositiveAction=this._oFullScreenPage.getPositiveAction();n.oNegativeAction=this._oFullScreenPage.getNegativeAction();if(this.extHookChangeFooterButtonsForExpertMode){this.extHookChangeFooterButtonsForExpertMode(n);if(n){if(n.oPositiveAction){this._oFullScreenPage.setPositiveAction(n.oPositiveAction);}if(n.oNegativeAction){this._oFullScreenPage.setNegativeAction(n.oNegativeAction);}if(n.aFooterButtons){var p=n.aFooterButtons.length;for(var j=0;j<p;j++){this._oFullScreenPage.addCustomFooterContent(n.aFooterButtons[j]);}}}}},getPositiveButton:function(o){if(!this.oPositiveButton){this.oPositiveButton=new P();}if(o){this.oPositiveButton.setText(o.DecisionText).attachPress(jQuery.proxy(this.showDecisionDialog,this,o));}else{this.oPositiveButton.setText(this._oResourceBundle.getText("XBUT_CONFIRM")).attachPress(jQuery.proxy(this.showConfirmDialog,this));}return this.oPositiveButton;},getNegativeButton:function(o){if(!this.oNegativeButton){this.oNegativeButton=new N();}this.oNegativeButton.setText(o.DecisionText).attachPress(jQuery.proxy(this.showDecisionDialog,this,o));return this.oNegativeButton;},getClaimButton:function(){if(!this.oClaimButton){this.oClaimButton=new f({text:this._oResourceBundle.getText("XBUT_CLAIM"),press:jQuery.proxy(this.sendActionForSelectedTasks,this,this.ClaimFunctionImport)});}return this.oClaimButton;},getReleaseButton:function(){if(!this.oReleaseButton){this.oReleaseButton=new f({text:this._oResourceBundle.getText("XBUT_RELEASE"),press:jQuery.proxy(this.sendActionForSelectedTasks,this,this.ReleaseFunctionImport)});}return this.oReleaseButton;},getForwardButton:function(){if(!this.oForwardButton){this.oForwardButton=new f({text:this._oResourceBundle.getText("XBUT_FORWARD"),press:jQuery.proxy(this.onForwardPopUp,this)});}return this.oForwardButton;},getResubmitButton:function(){if(!this.oResubmitButton){this.oResubmitButton=new f({text:this._oResourceBundle.getText("XBUT_RESUBMIT"),press:jQuery.proxy(this.showResubmitPopUp,this)});}return this.oResubmitButton;},showConfirmDialog:function(){this._oConfirmationDialogManager.showDecisionDialog({question:this._oResourceBundle.getText(this.oSelectedTasksDetails.aItems.length>1?"XMSG_CONFIRM_QUESTION_PLURAL":"XMSG_CONFIRM_QUESTION",[this.oSelectedTasksDetails.aItems.length]),showNote:false,title:this._oResourceBundle.getText("XTIT_SUBMIT_CONFIRM"),confirmButtonLabel:this._oResourceBundle.getText("XBUT_CONFIRM"),confirmActionHandler:jQuery.proxy(function(){this.sendActionForSelectedTasks(this.ConfirmFunctionImport);},this)});},showDecisionDialog:function(o){this._oConfirmationDialogManager.showDecisionDialog({question:this._oResourceBundle.getText(this.oSelectedTasksDetails.aItems.length>1?"XMSG_MULTI_DECISION_QUESTION_PLURAL":"XMSG_MULTI_DECISION_QUESTION",[o.DecisionText,this.oSelectedTasksDetails.aItems.length]),showNote:true,title:this._oResourceBundle.getText("XTIT_SUBMIT_DECISION"),confirmButtonLabel:this._oResourceBundle.getText("XBUT_SUBMIT"),noteMandatory:o.CommentMandatory,confirmActionHandler:jQuery.proxy(function(i,n){this.sendActionForSelectedTasks(this.DecisionFunctionImport,i,n);},this,o)});},sendActionForSelectedTasks:function(s,o,i){this.oDataManager.sendMultiAction(s,this.oSelectedTasksDetails.aItems,o,i,jQuery.proxy(this.handleActionPerformed,this),null);},onForwardPopUp:function(){},showResubmitPopUp:function(){R.open(this.sResubmitUniqueId,this,this.getView());},handleResubmitPopOverOk:function(){var o=sap.ui.core.Fragment.byId(this.sResubmitUniqueId,"DATE_RESUBMIT");var s=o.getSelectedDates();var i=s[0].getStartDate();var j=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-ddTHH:mm:ss"});this.oDataManager.doMassResubmit(this.oSelectedTasksDetails.aItems,"datetime'"+j.format(i)+"'",jQuery.proxy(this.handleActionPerformed,this),null);R.close();},handleActionPerformed:function(s,E,i){if(E.length===0){jQuery.sap.delayedCall(500,this,function(){sap.ca.ui.message.showMessageToast(this._oResourceBundle.getText(s.length>1?"dialog.success.multi_complete_plural":"dialog.success.multi_complete",s.length));});this.updateTableOnActionComplete(i);}else{l.openMessageDialog(s,E,jQuery.proxy(this.updateTableOnActionComplete,this,i));}},updateTableOnActionComplete:function(j){if(j&&j.length>0){var t=this.getView().getModel("taskList"),o;for(var i in j){o=j[i];var k=t.getProperty(this.oSelectedTasksDetails.aItems[o.index].sContextPath);for(var p in k){if(k.hasOwnProperty(p)&&o.oData.hasOwnProperty(p)){k[p]=o.oData[p];}}t.setProperty(this.oSelectedTasksDetails.aItems[o.index].sContextPath,k);}}this._oTable.removeSelections(true);this.handleSelectionChange();}});});
